<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帰参届システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --main-red: #e74c3c; --line-green: #06C755; }
        body { font-family: sans-serif; background: #f4f7f6; padding: 15px; margin: 0; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; font-size: 1.8rem; margin-bottom: 15px; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.85rem; }
        .req { color: red; margin-left: 5px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        .flex-row { display: flex; gap: 8px; align-items: center; }
        .flex-row div { flex: 1; }
        .red-box { border: 2px solid var(--main-red); padding: 12px; border-radius: 8px; margin-top: 15px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-confirm { background: #34495e; color: white; }
        .btn-next { background: #e67e22; color: white; }
        
        /* 画像化エリアの16:9向けスタイル */
        #captureArea { background: white; padding: 15px; border: 1px solid #eee; width: 750px; margin: 0 auto; }
        .confirm-layout { display: flex; gap: 15px; }
        .confirm-left { flex: 1; }
        .confirm-right { flex: 1.2; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 0.75rem; word-break: break-all; }
        th { background: #eee; }
        input[type="number"] { padding: 6px 2px; font-size: 1.1rem; text-align: center; }
        
        #confirmPage, #imageResultPage { display: none; }
        .hidden { display: none; }
        .result-img { width: 100%; max-width: 100%; border: 2px solid #333; margin-top: 10px; }
        .guide-box { font-size: 0.85rem; background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px solid #e67e22; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="inputPage" class="container">
    <h1>帰参届</h1>
    <label>教会名（団体名）<span class="req">*</span></label><input type="text" id="church">
    <label>帰参者名（代表）<span class="req">*</span></label><input type="text" id="repName">
    <label>連絡先<span class="req">*</span></label><input type="tel" id="tel">
    
    <label>人数</label>
    <div class="flex-row">
        <div><small>大人</small><input type="number" id="pAdult" oninput="calcTotal()" placeholder="0"></div>
        <div><small>子供</small><input type="number" id="pChild" oninput="calcTotal()" placeholder="0"></div>
        <div><small>乳児</small><input type="number" id="pBaby" oninput="calcTotal()" placeholder="0"></div>
    </div>
    <div id="totalDisplay" style="margin-top:5px; font-size:0.85rem; color:#666;">合計：0名</div>

    <label>詰所到着予定日時<span class="req">*</span></label>
    <div class="flex-row"><input type="date" id="arrDate" onchange="generateMealTable()"><input type="time" id="arrTime"></div>
    <label>詰所出発予定日時<span class="req">*</span></label>
    <div class="flex-row"><input type="date" id="depDate" onchange="generateMealTable()"><input type="time" id="depTime"></div>

    <label>交通手段</label>
    <select id="transportMain" onchange="toggleTransport()">
        <option value="">選択してください</option>
        <option value="公共交通">公共交通</option>
        <option value="独自">独自</option>
    </select>
    <div id="transSubArea" class="hidden"><select id="transportSub" onchange="toggleCarNum()" style="margin-top:10px;"></select></div>
    <div id="carNumArea" class="hidden"><label>自家用車 台数</label><input type="number" id="carNum"></div>

    <h2>食事・宿泊</h2>
    <div id="dateList">日付を入力すると表示されます</div>

    <div class="red-box">
        <h3 style="color:red; margin:0 0 5px; font-size:1rem;">直属食券申込</h3>
        <div class="flex-row">
            <div><small>日付</small><input type="date" id="ticketDate"></div>
            <div><small>食数</small><input type="number" id="ticketCount" placeholder="0"></div>
        </div>
        <div style="font-size:0.75rem; color:#d35400; font-weight:bold; margin-top:5px;">※直属食券が発行される日、申込〆切日をよくご確認ください。</div>
    </div>
    
    <label>備考</label>
    <textarea id="memo" rows="2" placeholder="女性部屋希望、別席・願書等ある方もこちらにご記入下さい。"></textarea>

    <button class="btn btn-confirm" onclick="showConfirm()">確認ページへ</button>
</div>

<div id="confirmPage" class="container" style="max-width: 850px;">
    <div id="captureArea">
        <h2 style="text-align: center; margin: 0 0 10px 0; border-bottom: 2px solid #333;">帰参届</h2>
        <div class="confirm-layout">
            <div class="confirm-left">
                <div id="summaryTable"></div>
                <div id="ticketArea"></div>
            </div>
            <div class="confirm-right">
                <div id="mealDetailTable"></div>
                <div id="memoArea" style="margin-top:10px; font-size:0.8rem; border:1px solid #ddd; padding:5px; height:60px; overflow:hidden;"></div>
            </div>
        </div>
    </div>
    <button class="btn btn-next" onclick="makeScreenshot()">次へ</button>
    <button class="btn" onclick="goBack()" style="background:#ccc;">修正する</button>
</div>

<div id="imageResultPage" class="container">
    <h1>送信用画像</h1>
    <div class="guide-box">
        <strong>【送信方法】</strong><br>
        ●iPhoneの方：画像をタップ後長押し、「共有」からLINE送信。<br>
        ●Androidの方：スクショし、範囲を整えてLINE送信。
    </div>
    <div id="imageDisplay" style="text-align: center;"></div>
    <button class="btn" onclick="backToConfirm()" style="background:#ccc; margin-top:20px;">戻る</button>
</div>

<script>
    // 既存のロジックを維持しつつ、表示関数を横型用に修正
    function calcTotal() {
        const a = Number(document.getElementById('pAdult').value || 0);
        const c = Number(document.getElementById('pChild').value || 0);
        const b = Number(document.getElementById('pBaby').value || 0);
        document.getElementById('totalDisplay').innerText = `合計：${a + c + b}名`;
    }

    function toggleTransport() {
        const main = document.getElementById('transportMain').value;
        const sub = document.getElementById('transportSub');
        const subArea = document.getElementById('transSubArea');
        sub.innerHTML = '<option value="">詳細を選択</option>';
        if (main === "公共交通") {
            subArea.classList.remove('hidden');
            ['電車', 'バス'].forEach(v => sub.innerHTML += `<option value="${v}">${v}</option>`);
        } else if (main === "独自") {
            subArea.classList.remove('hidden');
            ['観光バス', 'マイクロバス', '自家用車', '他'].forEach(v => sub.innerHTML += `<option value="${v}">${v}</option>`);
        } else { subArea.classList.add('hidden'); }
        toggleCarNum();
    }

    function toggleCarNum() {
        const sub = document.getElementById('transportSub').value;
        const carArea = document.getElementById('carNumArea');
        if (sub === "自家用車") carArea.classList.remove('hidden');
        else carArea.classList.add('hidden');
    }

    function generateMealTable() {
        const s = document.getElementById('arrDate').value;
        const e = document.getElementById('depDate').value;
        if (!s || !e) return;
        const start = new Date(s); const end = new Date(e);
        let html = '<table><tr><th width="25%">日付</th><th>朝</th><th>昼</th><th>夕</th><th>泊</th></tr>';
        let curr = new Date(start);
        while (curr <= end) {
            const d = (curr.getMonth()+1) + '/' + curr.getDate();
            html += `<tr><td>${d}</td><td><input type="number" class="m-in"></td><td><input type="number" class="m-in"></td><td><input type="number" class="m-in"></td><td><input type="number" class="m-in"></td></tr>`;
            curr.setDate(curr.getDate() + 1);
        }
        document.getElementById('dateList').innerHTML = html + '</table>';
    }

    function formatNoYear(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        return (d.getMonth() + 1) + "月" + d.getDate() + "日";
    }

    function showConfirm() {
        const req = ['church', 'repName', 'tel', 'arrDate', 'depDate'];
        if (req.some(id => !document.getElementById(id).value)) { alert('必須項目を入力してください'); return; }
        
        const a = Number(document.getElementById('pAdult').value || 0);
        const c = Number(document.getElementById('pChild').value || 0);
        const b = Number(document.getElementById('pBaby').value || 0);
        const carStr = document.getElementById('transportSub').value === "自家用車" ? `(${document.getElementById('carNum').value}台)` : "";

        // 左側：基本情報
        document.getElementById('summaryTable').innerHTML = `
            <table>
                <tr><th width="35%">教会名</th><td>${document.getElementById('church').value}</td></tr>
                <tr><th>代表者</th><td>${document.getElementById('repName').value}</td></tr>
                <tr><th>連絡先</th><td>${document.getElementById('tel').value}</td></tr>
                <tr><th>人数</th><td>${a+c+b}名 (大${a}/子${c}/乳${b})</td></tr>
                <tr><th>到着</th><td>${formatNoYear(document.getElementById('arrDate').value)} ${document.getElementById('arrTime').value}</td></tr>
                <tr><th>出発</th><td>${formatNoYear(document.getElementById('depDate').value)} ${document.getElementById('depTime').value}</td></tr>
                <tr><th>交通</th><td>${document.getElementById('transportMain').value}-${document.getElementById('transportSub').value}${carStr}</td></tr>
            </table>
        `;

        // 右側：食事明細
        let mRows = "";
        document.querySelectorAll('#dateList tr').forEach((tr, i) => {
            if(i === 0) return;
            const v = Array.from(tr.querySelectorAll('input')).map(inp => inp.value || "0");
            mRows += `<tr><td>${tr.cells[0].innerText}</td><td>${v[0]}</td><td>${v[1]}</td><td>${v[2]}</td><td>${v[3]}</td></tr>`;
        });
        document.getElementById('mealDetailTable').innerHTML = `<table><tr><th width="25%">日付</th><th>朝</th><th>昼</th><th>夕</th><th>泊</th></tr>${mRows}</table>`;

        // 直属食券
        const tDate = document.getElementById('ticketDate').value;
        const tCount = document.getElementById('ticketCount').value;
        document.getElementById('ticketArea').innerHTML = (tDate && tCount && tCount != "0") 
            ? `<div style="color:red; font-weight:bold; border:1px solid red; padding:3px; margin-top:5px; font-size:0.8rem; text-align:center;">直属食券: ${formatNoYear(tDate)} ${tCount}枚</div>` : "";

        // 備考
        document.getElementById('memoArea').innerHTML = `<strong>備考:</strong> ${document.getElementById('memo').value}`;

        document.getElementById('inputPage').style.display = 'none';
        document.getElementById('confirmPage').style.display = 'block';
        window.scrollTo(0,0);
    }

    async function makeScreenshot() {
        const area = document.getElementById('captureArea');
        // 解像度を保ちつつ16:9に近い比率でキャプチャ
        const canvas = await html2canvas(area, {scale: 2});
        const imgData = canvas.toDataURL("image/png");
        document.getElementById('imageDisplay').innerHTML = `<img src="${imgData}" class="result-img">`;
        document.getElementById('confirmPage').style.display = 'none';
        document.getElementById('imageResultPage').style.display = 'block';
        window.scrollTo(0,0);
    }

    function backToConfirm() {
        document.getElementById('imageResultPage').style.display = 'none';
        document.getElementById('confirmPage').style.display = 'block';
    }
    function goBack() {
        document.getElementById('confirmPage').style.display = 'none';
        document.getElementById('inputPage').style.display = 'block';
    }
</script>
</body>
</html>
